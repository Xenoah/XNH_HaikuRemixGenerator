<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- SEO Meta Tags -->
    <title>ä¿³å¥ä¸‡è¯ç‹‚ - AIä¿³å¥ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ | Haiku Mangekyo</title>
    <meta name="description" content="ã€Œä¿³å¥ä¸‡è¯ç‹‚ã€ã¯ã€å¤ä»Šã®åå¥ï¼ˆå¹³å®‰ã€œæ˜æ²»ï¼‰ã¨AIï¼ˆGeminiï¼‰ãŒè© ã‚“ã å¥ã‚’ãƒªãƒŸãƒƒã‚¯ã‚¹ã—ã€æ–°ãŸãªã‚«ã‚ªã‚¹ã¨ç¾ã‚’ç”Ÿã¿å‡ºã™ä¿³å¥ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ™‚ä»£ã‚’è¶…ãˆãŸè¨€è‘‰ã®èª¿åˆã§ã€ã‚ãªãŸã ã‘ã®ä¿³å¥ã‚’ä½œæˆãƒ»å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚" />
    <meta name="keywords" content="ä¿³å¥, AIä¿³å¥, ä¿³å¥ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼, ä¿³å¥ãƒ¡ãƒ¼ã‚«ãƒ¼, çŸ­æ­Œ, å’Œæ­Œ, æ¾å°¾èŠ­è•‰, æ­£å²¡å­è¦, Gemini, äººå·¥çŸ¥èƒ½, æ—¥æœ¬æ–‡åŒ–, è¨€è‘‰éŠã³" />
    <meta name="author" content="Kunihiko Sugiura" />
    <meta name="robots" content="index, follow" />
    <meta name="theme-color" content="#233b6e" />

    <!-- Open Graph / Facebook / LINE -->
    <meta property="og:type" content="website" />
    <!-- å®Ÿéš›ã®å…¬é–‹URLã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ -->
    <meta property="og:url" content="https://kunihiko-sugiura.github.io/haiku-mangekyo/" />
    <meta property="og:title" content="ä¿³å¥ä¸‡è¯ç‹‚ - AIä¿³å¥ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼" />
    <meta property="og:description" content="å¤ä»Šã®åå¥ã¨AIç”Ÿæˆå¥ã‚’ãƒªãƒŸãƒƒã‚¯ã‚¹ã€‚è¨€è‘‰ã®ä¸‡è¯é¡ã‚’è¦—ã„ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ" />
    <meta property="og:image" content="https://kunihiko-sugiura.github.io/haiku-mangekyo/ogp.png" />
    <meta property="og:site_name" content="ä¿³å¥ä¸‡è¯ç‹‚" />
    <meta property="og:locale" content="ja_JP" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://kunihiko-sugiura.github.io/haiku-mangekyo/" />
    <meta name="twitter:title" content="ä¿³å¥ä¸‡è¯ç‹‚ - AIä¿³å¥ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼" />
    <meta name="twitter:description" content="å¤ä»Šã®åå¥ã¨AIç”Ÿæˆå¥ã‚’ãƒªãƒŸãƒƒã‚¯ã‚¹ã€‚è¨€è‘‰ã®ä¸‡è¯é¡ã‚’è¦—ã„ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ" />
    <meta name="twitter:image" content="https://kunihiko-sugiura.github.io/haiku-mangekyo/ogp.png" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://kunihiko-sugiura.github.io/haiku-mangekyo/" />

    <!-- Favicon (Data URI for immediate display) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¸</text></svg>">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ä¿³å¥ä¸‡è¯ç‹‚",
      "alternateName": "Haiku Mangekyo",
      "description": "å¤ä»Šã®åå¥ã¨AIç”Ÿæˆå¥ã‚’ãƒªãƒŸãƒƒã‚¯ã‚¹ã—ã€æ–°ãŸãªä¿³å¥ã‚’ç”Ÿæˆã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚",
      "url": "https://kunihiko-sugiura.github.io/haiku-mangekyo/",
      "applicationCategory": "EntertainmentApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "JPY"
      },
      "author": {
        "@type": "Person",
        "name": "Kunihiko Sugiura"
      }
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;800&family=Zen+Kurenaido&display=swap" rel="stylesheet">
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              serif: ['"Shippori Mincho"', 'serif'],
              hand: ['"Zen Kurenaido"', 'sans-serif'],
            },
            colors: {
              'wasabi': '#7d8d4e',
              'indigo-dye': '#233b6e',
              'vermilion': '#d93a32',
              'sumi': '#2d2d2d',
              'paper': '#fcfaf2',
              'paper-dark': '#1c1c1e',
              'paper-card-dark': '#2c2c2e',
            },
            backgroundImage: {
              'paper-texture': "url('https://www.transparenttextures.com/patterns/cream-paper.png')",
            }
          }
        }
      }
    </script>
    <style>
      .vertical-text {
        writing-mode: vertical-rl;
        text-orientation: upright;
      }
      body {
        transition: background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1), color 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Refined animation timing */
      .ease-refined {
        transition-timing-function: cubic-bezier(0.22, 1, 0.36, 1);
      }

      /* Card glass shadow (multi-layer Apple-style) */
      .card-shadow {
        box-shadow:
          0 1px 2px rgba(0,0,0,0.04),
          0 4px 8px rgba(0,0,0,0.04),
          0 12px 24px rgba(0,0,0,0.06),
          0 24px 48px rgba(0,0,0,0.04);
        transition: box-shadow 0.5s cubic-bezier(0.22, 1, 0.36, 1), transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
      }
      .card-shadow:hover {
        box-shadow:
          0 2px 4px rgba(0,0,0,0.04),
          0 8px 16px rgba(0,0,0,0.06),
          0 20px 40px rgba(0,0,0,0.08),
          0 32px 64px rgba(0,0,0,0.06);
        transform: translateY(-2px);
      }
      .dark .card-shadow {
        box-shadow:
          0 1px 2px rgba(0,0,0,0.2),
          0 4px 8px rgba(0,0,0,0.2),
          0 12px 24px rgba(0,0,0,0.3),
          0 24px 48px rgba(0,0,0,0.2);
      }
      .dark .card-shadow:hover {
        box-shadow:
          0 2px 4px rgba(0,0,0,0.2),
          0 8px 16px rgba(0,0,0,0.3),
          0 20px 40px rgba(0,0,0,0.4),
          0 32px 64px rgba(0,0,0,0.3);
      }

      /* Subtle background gradient */
      .bg-gradient-refined {
        background: linear-gradient(160deg, #f5f3ee 0%, #faf9f6 40%, #f0ede6 100%);
      }
      .dark .bg-gradient-refined {
        background: linear-gradient(160deg, #0a0a0a 0%, #141414 40%, #0e0e0e 100%);
      }

      /* Settings gear hover rotation */
      .settings-btn:hover svg {
        transform: rotate(60deg);
        transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
      }
      .settings-btn svg {
        transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
      }

      /* Fade-in keyframe for overlays */
      @keyframes fadeIn {
        from { opacity: 0; backdrop-filter: blur(0); }
        to { opacity: 1; backdrop-filter: blur(12px); }
      }

      .goog-te-banner-frame.skiptranslate { display: none !important; }
      body { top: 0px !important; }
      #google_translate_element .goog-te-gadget-simple {
        background-color: transparent !important;
        border: 1px solid rgba(120, 120, 120, 0.15) !important;
        padding: 8px 12px !important;
        border-radius: 8px !important;
        font-family: sans-serif !important;
      }
      .dark #google_translate_element .goog-te-gadget-simple {
        background-color: rgba(255, 255, 255, 0.06) !important;
        border: 1px solid rgba(255, 255, 255, 0.12) !important;
      }
      #google_translate_element .goog-te-gadget-simple span { color: #666 !important; }
      .dark #google_translate_element .goog-te-gadget-simple span { color: #aaa !important; }
    </style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
    
    <!-- Application Logic Embedded Here -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { RefreshCw, Share2, Settings, Info, Feather, User, X, Moon, Sun, Languages, PenTool, Calendar, Check, Loader2, AlertCircle, CheckSquare, Square } from 'lucide-react';

      // ==========================================
      // UTILS: Generator Logic
      // ==========================================
      const getEras = (data) => {
        if (!data) return [];
        // JSONãƒ‡ãƒ¼ã‚¿å†…ã§ã®å‡ºç¾é †åºã‚’ç¶­æŒã—ã¦ä¸€æ„ã®æ™‚ä»£ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
        // ã“ã‚Œã«ã‚ˆã‚Šã€JSå´ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãªãã€JSONå´ã§ã‚«ãƒ†ã‚´ãƒªã®è¿½åŠ ã‚„ä¸¦ã³æ›¿ãˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
        return Array.from(new Set(data.map(h => h.era)));
      };

      const getRandomElement = (array) => {
        if (!array || array.length === 0) return null;
        return array[Math.floor(Math.random() * array.length)];
      };

      const generateRandomHaiku = (selectedEras, data) => {
        if (!data || data.length === 0) return null;
        let source = data;

        if (selectedEras.length > 0) {
          source = data.filter(h => selectedEras.includes(h.era));
        }

        if (source.length === 0) return null;

        const kamiList = source.map(h => ({ 
          text: h.kami, 
          sourceAuthor: h.author, 
          sourceHaiku: `${h.kami}${h.naka}${h.shimo}` 
        }));
        
        const nakaList = source.map(h => ({ 
          text: h.naka, 
          sourceAuthor: h.author, 
          sourceHaiku: `${h.kami}${h.naka}${h.shimo}` 
        }));
        
        const shimoList = source.map(h => ({ 
          text: h.shimo, 
          sourceAuthor: h.author, 
          sourceHaiku: `${h.kami}${h.naka}${h.shimo}` 
        }));

        const kami = getRandomElement(kamiList);
        const naka = getRandomElement(nakaList);
        const shimo = getRandomElement(shimoList);

        if (!kami || !naka || !shimo) return null;

        return {
          kami,
          naka,
          shimo,
          id: Date.now().toString(),
        };
      };

      const getAllCounts = (selectedEras, data) => {
        if (!data) return { kami: 0, naka: 0, shimo: 0, totalCombinations: 0 };
        let source = data;
        if (selectedEras.length > 0) {
          source = data.filter(h => selectedEras.includes(h.era));
        }
        
        const count = source.length;
        return {
          kami: count,
          naka: count,
          shimo: count,
          totalCombinations: count * count * count
        };
      };

      // ==========================================
      // COMPONENT: HaikuCard
      // ==========================================
      const HaikuCard = ({ haiku, isAnimating, customName }) => {
        const [showSource, setShowSource] = useState(false);

        useEffect(() => {
          setShowSource(false);
        }, [haiku]);

        return (
          <div className="relative w-full max-w-[340px] md:max-w-[400px] aspect-[6/7] mx-auto card-shadow bg-white/80 dark:bg-stone-900/80 backdrop-blur-xl rounded-lg border border-stone-200/60 dark:border-stone-700/40 group">

            {/* Subtle inner border */}
            <div className="absolute inset-3 border border-stone-200/30 dark:border-stone-600/20 rounded pointer-events-none z-20"></div>

            {/* Paper texture overlay (subtle) */}
            <div className="absolute inset-0 bg-paper-texture opacity-20 pointer-events-none mix-blend-multiply dark:mix-blend-overlay dark:opacity-10 z-10 rounded-lg"></div>
            
            {/* Content Container */}
            <div className="relative z-20 w-full h-full p-6 md:p-10 flex flex-row-reverse justify-between items-stretch select-none notranslate">
              
              {/* Kami (Top 5) */}
              <div className="flex-1 flex justify-center pt-2 md:pt-6">
                 <div className={`vertical-text text-[1.7rem] md:text-[2.2rem] font-serif text-sumi/90 dark:text-stone-100/90 tracking-[0.15em] leading-normal whitespace-nowrap ease-refined ${isAnimating ? 'opacity-0 -translate-y-3 blur-[2px] transition-all duration-500' : 'opacity-100 translate-y-0 blur-0 transition-all duration-1000'}`}>
                   {haiku.kami.text}
                 </div>
              </div>

              {/* Naka (Middle 7) */}
              <div className="flex-1 flex justify-center pt-16 md:pt-24">
                 <div className={`vertical-text text-[1.7rem] md:text-[2.2rem] font-serif text-sumi/90 dark:text-stone-100/90 tracking-[0.15em] leading-normal whitespace-nowrap ease-refined ${isAnimating ? 'opacity-0 -translate-y-3 blur-[2px] transition-all duration-500 delay-75' : 'opacity-100 translate-y-0 blur-0 transition-all duration-1000 delay-150'}`}>
                   {haiku.naka.text}
                 </div>
              </div>

              {/* Shimo (Bottom 5) */}
              <div className="flex-1 flex justify-center pt-32 md:pt-44">
                 <div className={`vertical-text text-[1.7rem] md:text-[2.2rem] font-serif text-sumi/90 dark:text-stone-100/90 tracking-[0.15em] leading-normal whitespace-nowrap ease-refined ${isAnimating ? 'opacity-0 -translate-y-3 blur-[2px] transition-all duration-500 delay-150' : 'opacity-100 translate-y-0 blur-0 transition-all duration-1000 delay-300'}`}>
                   {haiku.shimo.text}
                 </div>
              </div>

              {/* Author Signature Column */}
              <div className="w-10 md:w-12 flex flex-col justify-end pb-4 md:pb-8 items-center mr-1 md:mr-2">
                  <div className={`vertical-text text-sm md:text-base text-stone-400 dark:text-stone-500 font-serif tracking-[0.2em] mb-3 ease-refined ${isAnimating ? 'opacity-0 transition-all duration-300' : 'opacity-70 transition-all duration-1000 delay-500'}`}>
                    {customName}
                  </div>
                  {/* Hanko (Seal) */}
                  <div className={`ease-refined ${isAnimating ? 'opacity-0 scale-75 rotate-6 transition-all duration-300' : 'opacity-85 scale-100 rotate-[-3deg] transition-all duration-700 delay-700'}`}>
                     <div className="w-8 h-8 md:w-9 md:h-9 border border-vermilion/70 rounded flex items-center justify-center bg-vermilion/5 dark:bg-vermilion/15 text-vermilion/80 font-serif font-bold text-[9px] md:text-[10px]">
                       èª¿<br/>åˆ
                     </div>
                  </div>
              </div>
              
            </div>

             {/* Interactive Elements Overlay */}
             <div className="absolute top-0 right-0 p-4 z-30">
                 <button
                   onClick={(e) => { e.stopPropagation(); setShowSource(!showSource); }}
                   className="text-stone-300 dark:text-stone-600 hover:text-stone-500 dark:hover:text-stone-300 transition-all duration-300 p-2 rounded-full hover:bg-stone-100/30 dark:hover:bg-stone-800/30 hover:scale-110"
                   title="å¥ã®æ§‹æˆã‚’è¦‹ã‚‹"
                 >
                   <Info size={16} />
                 </button>
              </div>

              {/* Source Details Modal/Overlay */}
              {showSource && (
                 <div
                   className="absolute inset-0 z-40 bg-white/90 dark:bg-stone-900/90 backdrop-blur-md p-8 flex flex-col justify-center rounded-lg"
                   onClick={() => setShowSource(false)}
                   style={{ animation: 'fadeIn 0.3s cubic-bezier(0.22, 1, 0.36, 1)' }}
                 >
                    <div className="border-y border-stone-200/50 dark:border-stone-700/50 py-6 space-y-6" onClick={(e) => e.stopPropagation()}>
                      <h3 className="text-center font-medium text-stone-600 dark:text-stone-300 font-sans text-xs tracking-[0.2em] uppercase flex justify-center items-center gap-2">
                        <Feather size={12}/> å¼•ç”¨å…ƒ
                      </h3>
                      
                      <div className="space-y-4 font-serif">
                        <div className="grid grid-cols-[auto_1fr] gap-4 items-baseline">
                          <span className="text-stone-400 text-xs text-right w-8">ä¸Šäº”</span>
                          <div>
                            <span className="text-lg text-sumi dark:text-stone-100 mr-2">{haiku.kami.text}</span>
                            <span className="text-xs text-stone-500 dark:text-stone-400 block md:inline">- {haiku.kami.sourceAuthor}</span>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-[auto_1fr] gap-4 items-baseline">
                          <span className="text-stone-400 text-xs text-right w-8">ä¸­ä¸ƒ</span>
                          <div>
                            <span className="text-lg text-sumi dark:text-stone-100 mr-2">{haiku.naka.text}</span>
                            <span className="text-xs text-stone-500 dark:text-stone-400 block md:inline">- {haiku.naka.sourceAuthor}</span>
                          </div>
                        </div>

                        <div className="grid grid-cols-[auto_1fr] gap-4 items-baseline">
                          <span className="text-stone-400 text-xs text-right w-8">ä¸‹äº”</span>
                          <div>
                            <span className="text-lg text-sumi dark:text-stone-100 mr-2">{haiku.shimo.text}</span>
                            <span className="text-xs text-stone-500 dark:text-stone-400 block md:inline">- {haiku.shimo.sourceAuthor}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="mt-8 text-center">
                       <button onClick={() => setShowSource(false)} className="text-[11px] text-stone-400 hover:text-stone-600 dark:hover:text-stone-200 font-sans tracking-wider transition-colors duration-300">
                         é–‰ã˜ã‚‹
                       </button>
                    </div>
                 </div>
              )}
          </div>
        );
      };

      // ==========================================
      // COMPONENT: SettingsPanel
      // ==========================================
      const SettingsPanel = ({ 
        isOpen, 
        onClose, 
        selectedEras, 
        onEraChange,
        isDarkMode,
        toggleTheme,
        customName,
        onCustomNameChange,
        allEras,
        eraCounts
      }) => {
        useEffect(() => {
          if (isOpen) {
            if (!document.getElementById('google-translate-script')) {
              const script = document.createElement('script');
              script.id = 'google-translate-script';
              script.src = "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
              document.body.appendChild(script);

              window.googleTranslateElementInit = () => {
                if (window.google && window.google.translate) {
                   new window.google.translate.TranslateElement({
                    pageLanguage: 'ja',
                    layout: window.google.translate.TranslateElement.InlineLayout.SIMPLE,
                    autoDisplay: false
                  }, 'google_translate_element');
                }
              };
            } else {
              if (window.google && window.google.translate && window.googleTranslateElementInit) {
                   window.googleTranslateElementInit();
              }
            }
          }
        }, [isOpen]);

        const handleSelectAll = () => {
          onEraChange([...allEras]);
        };

        const handleDeselectAll = () => {
          onEraChange([]);
        };

        return (
          <>
            {/* Backdrop */}
            <div
              className={`fixed inset-0 bg-black/30 backdrop-blur-sm z-40 transition-opacity duration-500 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
              onClick={onClose}
            />

            {/* Panel */}
            <div
              className={`fixed top-0 right-0 h-full w-full max-w-sm bg-white/95 dark:bg-stone-900/95 backdrop-blur-xl shadow-2xl z-50 transform transition-transform duration-500 ease-refined overflow-y-auto ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}
            >
              <div className="p-7 space-y-8">

                <div className="flex justify-between items-center border-b border-stone-200/50 dark:border-stone-700/50 pb-5">
                  <h2 className="text-lg font-serif font-semibold text-sumi dark:text-stone-100 tracking-wider">è¨­å®š</h2>
                  <button onClick={onClose} className="text-stone-400 hover:text-stone-600 dark:hover:text-stone-200 transition-colors duration-300 hover:scale-110">
                    <X size={20} />
                  </button>
                </div>

                <section>
                  <h3 className="text-[11px] font-sans font-medium text-stone-400 uppercase tracking-[0.15em] mb-4">
                    å¤–è¦³
                  </h3>
                  <button
                    onClick={toggleTheme}
                    className="w-full flex items-center justify-between p-3.5 rounded-lg border border-stone-200/50 dark:border-stone-700/50 hover:bg-stone-50/50 dark:hover:bg-stone-800/50 transition-all duration-300 text-sumi dark:text-stone-100"
                  >
                    <span className="font-serif text-sm">
                      {isDarkMode ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'}
                    </span>
                    {isDarkMode ? <Moon size={18} className="text-stone-400" /> : <Sun size={18} className="text-stone-400" />}
                  </button>
                </section>

                <section>
                  <h3 className="text-[11px] font-sans font-medium text-stone-400 uppercase tracking-[0.15em] mb-4 flex items-center gap-2">
                    <PenTool size={13}/> ç½²å
                  </h3>
                  <div className="relative">
                    <input
                      type="text"
                      value={customName}
                      onChange={(e) => onCustomNameChange(e.target.value)}
                      maxLength={6}
                      placeholder="åå‰ã‚’å…¥åŠ›"
                      className="w-full p-3.5 rounded-lg border border-stone-200/50 dark:border-stone-700/50 bg-white/50 dark:bg-stone-800/50 text-sumi dark:text-stone-100 font-serif text-sm focus:ring-1 focus:ring-stone-300 dark:focus:ring-stone-600 outline-none transition-all duration-300"
                    />
                    <span className="absolute right-3.5 top-3.5 text-[10px] text-stone-300 dark:text-stone-600 font-sans pointer-events-none">
                      {customName.length}/6
                    </span>
                  </div>
                </section>

                <section>
                   <div className="flex justify-between items-end mb-4">
                     <h3 className="text-[11px] font-sans font-medium text-stone-400 uppercase tracking-[0.15em] flex items-center gap-2">
                      <Calendar size={13}/> ã‚½ãƒ¼ã‚¹
                    </h3>
                    <div className="flex gap-2">
                      <button
                        onClick={handleSelectAll}
                        className="text-[10px] px-2.5 py-1 rounded-md text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300 border border-stone-200/50 dark:border-stone-700/50 hover:border-stone-300/50 dark:hover:border-stone-600/50 transition-all duration-300"
                        title="å…¨é¸æŠ"
                      >
                        å…¨é¸æŠ
                      </button>
                      <button
                        onClick={handleDeselectAll}
                        className="text-[10px] px-2.5 py-1 rounded-md text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300 border border-stone-200/50 dark:border-stone-700/50 hover:border-stone-300/50 dark:hover:border-stone-600/50 transition-all duration-300"
                        title="å…¨è§£é™¤"
                      >
                        å…¨è§£é™¤
                      </button>
                    </div>
                   </div>

                  <div className="flex flex-col gap-1.5">
                    {allEras.map((era) => {
                      const isSelected = selectedEras.includes(era);
                      const count = eraCounts ? eraCounts[era] : 0;
                      return (
                        <label
                          key={era}
                          className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-300 ${
                            isSelected
                              ? 'bg-sumi/[0.03] dark:bg-white/[0.06] border-sumi/20 dark:border-stone-500/30'
                              : 'border-stone-200/30 dark:border-stone-700/30 hover:bg-stone-50/50 dark:hover:bg-stone-800/30'
                          }`}
                        >
                          <div className="flex items-center">
                            <div className={`w-4 h-4 rounded-sm border flex items-center justify-center mr-3 transition-all duration-300 ${
                              isSelected
                                ? 'bg-sumi border-sumi dark:bg-stone-200 dark:border-stone-200'
                                : 'bg-transparent border-stone-300 dark:border-stone-600'
                            }`}>
                               {isSelected && <Check size={11} className="text-white dark:text-stone-900" strokeWidth={3} />}
                            </div>
                            <input
                              type="checkbox"
                              value={era}
                              checked={isSelected}
                              onChange={(e) => onEraChange(era, e.target.checked)}
                              className="hidden"
                            />
                            <span className={`font-serif text-sm ${isSelected ? 'text-sumi dark:text-stone-200' : 'text-stone-500 dark:text-stone-400'}`}>
                              {era}
                              <span className="ml-2 text-[10px] font-sans text-stone-300 dark:text-stone-600 font-normal">
                                {count}å¥
                              </span>
                            </span>
                          </div>
                        </label>
                      );
                    })}
                  </div>
                  <p className="text-[10px] text-stone-300 dark:text-stone-600 mt-3 tracking-wider">é¸æŠã—ãŸæ™‚ä»£ã®å¥æã‚’çµ„ã¿åˆã‚ã›ã¦ç”Ÿæˆã—ã¾ã™</p>
                </section>

                <section>
                   <h3 className="text-[11px] font-sans font-medium text-stone-400 uppercase tracking-[0.15em] mb-4 flex items-center gap-2">
                    <Languages size={13}/> ç¿»è¨³
                  </h3>
                  <div className="bg-stone-50/50 dark:bg-stone-800/50 p-4 rounded-lg border border-stone-200/30 dark:border-stone-700/30">
                     <div id="google_translate_element" className="w-full min-h-[40px]"></div>
                  </div>
                </section>

                <section className="border-t border-stone-200/30 dark:border-stone-700/30 pt-6">
                   <h3 className="text-[11px] font-sans font-medium text-stone-400 uppercase tracking-[0.15em] mb-4 flex items-center gap-2">
                    <AlertCircle size={13}/> è‘—ä½œæ¨©ãƒ»å…è²¬äº‹é …
                  </h3>
                  <div className="text-[10px] text-stone-400 dark:text-stone-500 space-y-2 leading-relaxed bg-stone-50/50 dark:bg-stone-800/30 p-4 rounded-lg border border-stone-200/20 dark:border-stone-700/20">
                    <p>
                      <span className="font-bold">ã€åéŒ²å¥ã«ã¤ã„ã¦ã€‘</span><br/>
                      å¹³å®‰ï½æ±Ÿæˆ¸æ™‚ä»£ã®å¥ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚‚ã®ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚æ˜æ²»ä»¥é™ã®å¥ã«ã¤ã„ã¦ã‚‚ã€åŸå‰‡ã¨ã—ã¦è‘—ä½œè€…ã®æ­»å¾Œ70å¹´ã‚’çµŒéã—ä¿è­·æœŸé–“ãŒæº€äº†ã—ãŸã‚‚ã®ã‚’æ¡ç”¨ã™ã‚‹ã‚ˆã†åŠªã‚ã¦ã„ã¾ã™ã€‚
                    </p>
                    <p>
                      <span className="font-bold">ã€AIç”Ÿæˆå¥ã«ã¤ã„ã¦ã€‘</span><br/>
                      ã€ŒAIã€ã‚«ãƒ†ã‚´ãƒªã®ä¿³å¥ã¯ã€å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆGeminiï¼‰ã«ã‚ˆã£ã¦ç¢ºç‡çš„ã«ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚æ—¢å­˜ã®è‘—ä½œç‰©ã¨å¶ç„¶ã«é¡ä¼¼ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ç‰¹å®šã®ä½œå“ã‚’æ„å›³çš„ã«æ¨¡å€£ã¾ãŸã¯ä¾µå®³ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                    </p>
                  </div>
                </section>

              </div>
            </div>
          </>
        );
      };

      // ==========================================
      // APP COMPONENT
      // ==========================================
      const App = () => {
        const [haikuData, setHaikuData] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [currentHaiku, setCurrentHaiku] = useState(null);
        const [isAnimating, setIsAnimating] = useState(false);
        const [selectedEras, setSelectedEras] = useState([]);
        const [customName, setCustomName] = useState('äººå·¥çŸ¥èƒ½');
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isDarkMode, setIsDarkMode] = useState(false);
        const [counts, setCounts] = useState({kami:0, naka:0, shimo:0, totalCombinations:0});
        const [allEras, setAllEras] = useState([]);
        const [eraCounts, setEraCounts] = useState({});

        useEffect(() => {
          fetch('./haikus.json')
            .then(res => res.json())
            .then(data => {
              setHaikuData(data);
              const eras = getEras(data);
              setAllEras(eras);
              setSelectedEras(eras);
              
              // Calculate counts per era
              const eCounts = {};
              data.forEach(h => {
                eCounts[h.era] = (eCounts[h.era] || 0) + 1;
              });
              setEraCounts(eCounts);

              const counts = getAllCounts(eras, data);
              setCounts(counts);
              
              if (counts.totalCombinations > 0) {
                 const initialHaiku = generateRandomHaiku(eras, data);
                 setCurrentHaiku(initialHaiku);
              }
              setIsLoading(false);
            })
            .catch(err => {
              console.error("Failed to load haikus", err);
              setIsLoading(false);
            });
        }, []);

        useEffect(() => {
          if (isDarkMode) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }, [isDarkMode]);

        const refreshHaiku = (eras, data = haikuData) => {
          const counts = getAllCounts(eras, data);
          setCounts(counts);
          
          if (counts.totalCombinations === 0) {
            setCurrentHaiku(null);
            return;
          }
        }

        const handleEraChange = (era, isChecked) => {
          // Bulk update handling: if era is an array, set it directly
          if (Array.isArray(era)) {
             const newEras = era;
             setSelectedEras(newEras);
             refreshHaiku(newEras);
             return;
          }

          let newEras = [...selectedEras];
          if (isChecked) {
            if (!newEras.includes(era)) newEras.push(era);
          } else {
            newEras = newEras.filter(e => e !== era);
          }
          
          setSelectedEras(newEras);
          refreshHaiku(newEras);
        };

        const handleGenerate = () => {
          if (isAnimating) return;
          setIsAnimating(true);
          setTimeout(() => {
            const newHaiku = generateRandomHaiku(selectedEras, haikuData);
            if (newHaiku) {
              setCurrentHaiku(newHaiku);
            }
            setTimeout(() => {
              setIsAnimating(false);
            }, 100);
          }, 800);
        };

        const handleShare = async () => {
          if (currentHaiku) {
              const text = `${currentHaiku.kami.text} ${currentHaiku.naka.text} ${currentHaiku.shimo.text}\n\nèª¿åˆ: ${customName}\n#ä¿³å¥ä¸‡è¯ç‹‚ #AIä¿³å¥`;
              const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
              
              if (isMobile && navigator.share) {
                   try {
                       await navigator.share({
                           title: 'ä¿³å¥ä¸‡è¯ç‹‚',
                           text: text,
                       });
                   } catch (err) {
                       console.log("Share cancelled");
                   }
              } else {
                   const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                   window.open(url, '_blank');
              }
          }
        };
        
        const handleSaveImage = async () => {
          if (isAnimating) return;
          const html2canvas = (await import('https://esm.sh/html2canvas@1.4.1')).default;
          const cardElement = document.getElementById('haiku-card-container');
          if (!cardElement) return;

          try {
              const canvas = await html2canvas(cardElement, {
                  scale: 2,
                  backgroundColor: null,
                  logging: false,
                  useCORS: true,
                  ignoreElements: (element) => {
                      return element.getAttribute('data-html2canvas-ignore') === 'true';
                  }
              });

              const image = canvas.toDataURL("image/png");
              const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

              if (isMobile && navigator.canShare) {
                   const blob = await (await fetch(image)).blob();
                   const file = new File([blob], "haiku-mangekyo.png", { type: "image/png" });
                   try {
                      if (navigator.canShare({ files: [file] })) {
                          await navigator.share({
                              files: [file],
                              title: 'ä¿³å¥ä¸‡è¯ç‹‚',
                              text: 'AIãŒè© ã‚“ã ä¿³å¥'
                          });
                          return;
                      }
                   } catch (e) {
                       console.log("Sharing failed", e);
                   }
              }
              const link = document.createElement('a');
              link.download = `haiku-mangekyo-${Date.now()}.png`;
              link.href = image;
              link.click();
          } catch (err) {
              console.error("Failed to generate image", err);
              alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        };

        const getButtonLabel = () => {
            if (isLoading) return 'èª­ã¿è¾¼ã¿ä¸­...';
            if (haikuData.length === 0) return 'ä¿³å¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            if (selectedEras.length === 0) return 'æ™‚ä»£ã‚’é¸æŠã—ã¦ãã ã•ã„';
            const allEras = getEras(haikuData);
            if (selectedEras.length === allEras.length) return 'ãƒ©ãƒ³ãƒ€ãƒ ã§èª¿åˆ';
            return 'é¸æŠã—ãŸæ™‚ä»£ã§èª¿åˆ';
        };

        return (
          <div className={`min-h-screen bg-gradient-refined transition-colors duration-500 font-serif text-sumi dark:text-stone-100 relative overflow-hidden flex flex-col selection:bg-wasabi/30 selection:text-sumi dark:selection:text-white`}>
            
            {/* Settings Button */}
            <div className="absolute top-5 right-5 z-50">
              <button
                onClick={() => setIsSettingsOpen(true)}
                disabled={isLoading}
                className="settings-btn p-3 text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300 transition-all duration-300 bg-white/40 dark:bg-white/5 rounded-full backdrop-blur-sm border border-stone-200/30 dark:border-stone-700/30 hover:bg-white/60 dark:hover:bg-white/10 disabled:opacity-40"
              >
                <Settings size={18} />
              </button>
            </div>

            <SettingsPanel 
              isOpen={isSettingsOpen}
              onClose={() => setIsSettingsOpen(false)}
              selectedEras={selectedEras}
              onEraChange={handleEraChange}
              isDarkMode={isDarkMode}
              toggleTheme={() => setIsDarkMode(!isDarkMode)}
              customName={customName}
              onCustomNameChange={setCustomName}
              allEras={allEras}
              eraCounts={eraCounts}
            />
            
            {/* Header */}
            <header className="relative z-10 w-full pt-12 md:pt-16 pb-6 text-center">
              <h1 className="text-4xl md:text-6xl font-bold tracking-[0.15em] text-sumi/90 dark:text-stone-100/90 flex flex-col md:flex-row items-center justify-center gap-1 md:gap-4">
                <span>ä¿³å¥</span>
                <span className="text-vermilion/80 dark:text-red-400/80">ä¸‡è¯ç‹‚</span>
              </h1>
              <p className="text-[10px] md:text-xs text-stone-400 dark:text-stone-500 mt-4 font-sans tracking-[0.3em] uppercase">
                Haiku Mangekyo
              </p>
            </header>

            {/* Main Content */}
            <main className="flex-grow relative z-10 flex flex-col items-center justify-center p-4 md:p-6 gap-10 md:gap-12">
              <div id="haiku-card-container" className="w-full flex justify-center py-4 px-2">
                {isLoading ? (
                  <div className="w-full max-w-[340px] md:max-w-[400px] aspect-[6/7] flex items-center justify-center text-stone-400 dark:text-stone-600 border border-dashed border-stone-200 dark:border-stone-700 rounded-lg">
                      <div className="flex flex-col items-center gap-3">
                        <Loader2 className="animate-spin" size={24} />
                        <p className="text-sm tracking-wider">è¨€è‘‰ã‚’é›†ã‚ã¦ã„ã¾ã™...</p>
                      </div>
                   </div>
                ) : currentHaiku ? (
                   <HaikuCard haiku={currentHaiku} isAnimating={isAnimating} customName={customName} />
                ) : (
                   <div className="w-full max-w-[340px] md:max-w-[400px] aspect-[6/7] flex items-center justify-center text-stone-400 dark:text-stone-600 border border-dashed border-stone-200 dark:border-stone-700 rounded-lg">
                      <p className="text-sm tracking-wider">è¨­å®šã‹ã‚‰æ™‚ä»£ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                   </div>
                )}
              </div>

              <div className="flex flex-col items-center gap-4 w-full max-w-[320px] z-20">
                <button
                  onClick={handleGenerate}
                  disabled={isAnimating || selectedEras.length === 0 || isLoading}
                  className="group w-full flex items-center justify-center gap-3 px-8 py-4 bg-sumi dark:bg-stone-100 text-white dark:text-sumi text-base font-semibold tracking-[0.15em] rounded-xl hover:scale-[1.02] hover:shadow-lg active:scale-[0.98] transition-all duration-300 ease-refined disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:shadow-none"
                >
                  <RefreshCw className={`transition-transform duration-700 ease-refined ${isAnimating || isLoading ? 'animate-spin' : 'group-hover:rotate-180'}`} size={18} />
                  <span>{getButtonLabel()}</span>
                </button>
                
                <div className="flex gap-3 w-full">
                  <button
                      onClick={handleShare}
                      disabled={!currentHaiku || isLoading}
                      className="flex-1 flex items-center justify-center gap-2 bg-white/50 dark:bg-white/5 p-3 rounded-lg border border-stone-200/50 dark:border-stone-700/50 hover:bg-white/80 dark:hover:bg-white/10 hover:border-stone-300/50 dark:hover:border-stone-600/50 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-200 transition-all duration-300 text-xs font-sans backdrop-blur-sm disabled:opacity-40"
                  >
                      <Share2 size={13} />
                      <span>ãƒ†ã‚­ã‚¹ãƒˆã§å…±æœ‰</span>
                  </button>
                   <button
                      onClick={handleSaveImage}
                      disabled={!currentHaiku || isLoading}
                      className="flex-1 flex items-center justify-center gap-2 bg-white/50 dark:bg-white/5 p-3 rounded-lg border border-stone-200/50 dark:border-stone-700/50 hover:bg-white/80 dark:hover:bg-white/10 hover:border-stone-300/50 dark:hover:border-stone-600/50 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-200 transition-all duration-300 text-xs font-sans backdrop-blur-sm disabled:opacity-40"
                  >
                      <Share2 size={13} />
                      <span>ç”»åƒã‚’ä¿å­˜</span>
                  </button>
                </div>

                <div className="text-[10px] md:text-[11px] text-stone-400 dark:text-stone-600 font-sans text-center leading-relaxed mt-2 tracking-wider">
                  <p className="mb-0.5">
                    {isLoading ? '...' : (selectedEras.length === allEras.length ? 'å¤ä»Šã®åå¥' : selectedEras.join('ãƒ»'))}ã‹ã‚‰èª¿åˆ
                  </p>
                  <p className="text-stone-300 dark:text-stone-700">{counts.totalCombinations.toLocaleString()} é€šã‚Š</p>
                </div>
              </div>
            </main>

            <footer className="relative z-10 w-full py-8 md:py-10 text-center text-stone-300 dark:text-stone-700 text-[10px]">
              <p className="tracking-[0.4em]">ã‚ã³ãƒ»ã•ã³ãƒ»AI</p>
            </footer>
          </div>
        );
      };

      // ==========================================
      // ENTRY POINT
      // ==========================================
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>